- name: update system
  yum: name='*' state=latest disable_gpg_check=yes
  register: isupdated

- name: reboot
  reboot:

- name: build hosts file
  lineinfile: dest=/etc/hosts regexp='.*{{ item }}$' line="{{ hostvars[item].ansible_eth0.ipv4.address }} {{item}}" state=present
  when: hostvars[item].ansible_eth0.ipv4.address is defined
  with_items: "{{ groups['all'] }}"

- name: disable selinux
  selinux: state=disabled

- name: disable of selinux - now
  command: setenforce 0

- name: Ensure net.bridge.bridge-nf-call-iptables is set. See kubeadm
  copy: src=k8s.conf owner=root group=root dest=/etc/sysctl.d/k8s.conf

- name: Run sysctl
  command: sysctl --system

- name: Add Kubernetes yum repo
  yum_repository:
    name: kubernetes
    description: Kubernetes kubeadm
    baseurl: https://packages.cloud.google.com/yum/repos/kubernetes-el7-x86_64
    gpgkey: https://packages.cloud.google.com/yum/doc/yum-key.gpg
    gpgcheck: yes

- name: Add libcontainers yum repo
  get_url:
    url: "https://download.opensuse.org/repositories/devel:/kubic:/libcontainers:/stable/CentOS_7/devel:kubic:libcontainers:stable.repo"
    dest: /etc/yum.repos.d/libcontainers.repo
    validate_certs: no

- name: Add cri-o yum repo
  get_url:
    url: "https://download.opensuse.org/repositories/devel:/kubic:/libcontainers:/stable:/cri-o:/1.17:/1.17.3/CentOS_7/devel:kubic:libcontainers:stable:cri-o:1.17:1.17.3.repo"
    dest: /etc/yum.repos.d/crio.repo
    validate_certs: no

- name: install utility programs
  yum: name={{ packages }} state=present disable_gpg_check=yes
  vars:
    packages:
      - etcd
      - wget
      - ntp
      - screen
      - epel-release
      - vim
      - iptables
      - iptables-utils
      - iptables-services
      - ncurses-term
      - kernel-devel
      - kernel-headers
      - cri-o
      - containernetworking-plugins


- name: install epel  utility programs
  yum: name={{ packages }} state=present disable_gpg_check=yes
  vars:
    packages:
      - jq
      - lvm2
      - yum-utils
      - device-mapper-persistent-data

- name: install yum set obsoletes
  command: yum-config-manager --save --setopt=obsoletes=0

- include_tasks: v123.yml
  when: kubever is defined and kubever == "v1.23"

- include_tasks: v124.yml
  when: kubever is defined and kubever == "v1.24"

- include_tasks: v125.yml
  when: kubever is defined and kubever == "v1.25"

- include_tasks: latest.yml
  when: kubever is not defined

- name: enable kube services
  service: name={{ item }} state=started enabled=yes
  with_items:
    - ntpd
    - kubelet
    - cri-o

- name: download crictl
  get_url:
    url: https://github.com/kubernetes-sigs/cri-tools/releases/download/v1.25.0/crictl-v1.25.0-linux-amd64.tar.gz
    dest: /home/vagrant/crictl.tar.gz

- name: install crictl
  unarchive:
    src: /home/vagrant/crictl.tar.gz
    remote_src: yes
    dest: /bin

- name: turn off swap
  command: swapoff -a

- name: remove swap from /etc/fstab
  lineinfile:
    path: /etc/fstab
    state: absent
    regexp: "swap"

- name: load br_netfilter
  command: modprobe br_netfilter

- name: set ip_forward
  shell: echo '1' > /proc/sys/net/ipv4/ip_forward

- name: set ip_forward in sysctl
  lineinfile: dest=/etc/sysctl.conf regexp='.*ip_forward=1$' line="net.ipv4.ip_forward=1" state=present


